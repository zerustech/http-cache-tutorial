#!/bin/bash

# This file is part of the ZerusTech HTTP Cache Tutorial package.
# 
# (c) Michael Lee <michael.lee@zerustech.com>
#
# For the full copyright and license information, please view the LICENSE file 
# that was distributed with this source code.

default_base=$(dirname `cd -P $(dirname $BASH_SOURCE) && pwd`) && source $default_base/../../bootstrap.sh
runtime_base=$(dirname `cd $(dirname $BASH_SOURCE) && pwd`)

# This script accepts optional arguments for starting a varnish cache server from
# command line. It is a wrapper to the varnish.service script.
# 
# @author Michael Lee <michael.lee@zerustech.com>

config_file=$runtime_base/etc/config.vcl
key_file=$app_etc/key
http_socket="0.0.0.0:80"
varnish_socket="localhost:6082"
runtime_params="-p vcl_dir=$runtime_base/etc"
params=""

function usage()
{
    printf "varnish.start: usage: varnish.start [-f config_file] [-S varnish_key_file] [-a http_host:http_port] [-T varnish_host:varnish_port] [-p param=value]\n"
    exit 0
}

while getopts "f:S:a:T:p:" opt; do

    case $opt in

        f) config_file="$OPTARG";;

        S) key_file="$OPTARG";;

        a) http_socket="$OPTARG";;

        T) varnish_socket="$OPTARG";;

        p) params=$OPTARG;;

        *) usage;;

    esac

done

shift $((OPTIND - 1))

if [ "$params" != "" ]; then

    runtime_params="$runtime_params -p $params"

fi

$app_vendor_zerustech_cli_bin/varnish/varnish.service -h "$varnish_home" -f "$config_file" -S "$key_file" -a "$http_socket" -T "$varnish_socket" start "$runtime_params" "$@"
